import { useEffect, useState, useRef } from 'react';
import socket from '@/lib/socket';

interface Message {
  id: string;
  text: string;
  sender: string;
  timestamp: Date;
  room: string;
}

interface ChatProps {
  room: string;
  currentUser: string;
}

export default function RealTimeChat({ room, currentUser }: ChatProps) {
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputText, setInputText] = useState<string>('');
  const [isConnected, setIsConnected] = useState<boolean>(false);
  const [isTyping, setIsTyping] = useState<boolean>(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // ìë™ ìŠ¤í¬ë¡¤ í•¨ìˆ˜
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  // ë©”ì‹œì§€ê°€ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ ìë™ ìŠ¤í¬ë¡¤
  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    // ì—°ê²° ìƒíƒœ ê´€ë¦¬
    socket.on('connect', () => setIsConnected(true));
    socket.on('disconnect', () => setIsConnected(false));
    
    // ë©”ì‹œì§€ ìˆ˜ì‹  - ID ìƒì„± ë¡œì§ ì¶”ê°€
    socket.on('message', (newMessage: Omit<Message, 'id'>) => {
      const messageWithId: Message = {
        ...newMessage,
        id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`, // ê³ ìœ  ID ìƒì„±
        timestamp: new Date(newMessage.timestamp) // Date ê°ì²´ë¡œ ë³€í™˜
      };
      
      setMessages(prev => [...prev, messageWithId]);
    });

    // íƒ€ì´í•‘ ìƒíƒœ ê´€ë¦¬
    socket.on('typing', (data: { user: string; isTyping: boolean }) => {
      if (data.user !== currentUser) {
        setIsTyping(data.isTyping);
      }
    });

    // ë°© ì°¸ì—¬
    socket.emit('join_room', { room, parent: currentUser });

    // ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë“œ (ì„ íƒì‚¬í•­)
    socket.emit('load_messages', { room });
    socket.on('previous_messages', (previousMessages: Message[]) => {
      setMessages(previousMessages);
    });

    return () => {
      socket.off('connect');
      socket.off('disconnect');
      socket.off('message');
      socket.off('typing');
      socket.off('previous_messages');
    };
  }, [room, currentUser]);

  const sendMessage = () => {
    if (!inputText.trim()) return;

    const messageData: Omit<Message, 'id'> = {
      text: inputText,
      sender: currentUser,
      timestamp: new Date(),
      room
    };

    // ì¦‰ì‹œ UIì— ë©”ì‹œì§€ ì¶”ê°€ (ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
    const optimisticMessage: Message = {
      ...messageData,
      id: `temp-${Date.now()}`
    };
    setMessages(prev => [...prev, optimisticMessage]);

    // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
    socket.emit('message', messageData);
    
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    setInputText('');
    
    // íƒ€ì´í•‘ ìƒíƒœ ì¤‘ì§€
    socket.emit('stop_typing', { room, user: currentUser });
  };

  // ì…ë ¥ ì¤‘ íƒ€ì´í•‘ ìƒíƒœ ì „ì†¡
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setInputText(e.target.value);
    
    // íƒ€ì´í•‘ ìƒíƒœ ì „ì†¡ (ë””ë°”ìš´ì‹±)
    socket.emit('typing', { room, user: currentUser, isTyping: true });
    
    // 3ì´ˆ í›„ íƒ€ì´í•‘ ì¤‘ì§€
    setTimeout(() => {
      socket.emit('typing', { room, user: currentUser, isTyping: false });
    }, 3000);
  };

  const handleKeyPress = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  return (
    <div className="flex flex-col h-96 bg-white rounded-lg shadow-lg">
      {/* í—¤ë” */}
      <div className="bg-blue-600 text-white p-4 rounded-t-lg">
        <h3 className="font-bold">101ë™ ë“±í•˜ì› ì¹œêµ¬ë“¤</h3>
        <p className="text-sm opacity-80 flex items-center">
          {isConnected ? (
            <>
              <span className="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
              ì—°ê²°ë¨
            </>
          ) : (
            <>
              <span className="w-2 h-2 bg-red-400 rounded-full mr-2"></span>
              ì—°ê²° ì¤‘...
            </>
          )}
        </p>
      </div>
      
      {/* ë©”ì‹œì§€ ì˜ì—­ */}
      <div className="flex-1 overflow-y-auto p-4 space-y-2">
        {messages.length === 0 ? (
          <div className="text-center text-gray-500 mt-8">
            <p>ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p className="text-sm">ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”! ğŸ‘‹</p>
          </div>
        ) : (
          messages.map((msg) => (
            <div
              key={msg.id}
              className={`p-2 rounded-lg max-w-xs ${
                msg.sender === currentUser
                  ? 'bg-blue-500 text-white ml-auto'
                  : 'bg-gray-100 text-gray-800'
              }`}
            >
              <p className="text-sm">{msg.text}</p>
              <p className="text-xs opacity-70 mt-1">
                {msg.sender === currentUser ? 'ë‚˜' : msg.sender} â€¢ {' '}
                {new Date(msg.timestamp).toLocaleTimeString('ko-KR', {
                  hour: '2-digit',
                  minute: '2-digit'
                })}
              </p>
            </div>
          ))
        )}
        
        {/* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */}
        {isTyping && (
          <div className="bg-gray-100 text-gray-600 p-2 rounded-lg max-w-xs text-sm">
            <div className="flex items-center">
              <div className="typing-dots flex space-x-1">
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
              </div>
              <span className="ml-2">ì…ë ¥ ì¤‘...</span>
            </div>
          </div>
        )}
        
        {/* ìë™ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ì°¸ì¡°ì  */}
        <div ref={messagesEndRef} />
      </div>
      
      {/* ì…ë ¥ ì˜ì—­ */}
      <div className="p-4 border-t">
        <div className="flex space-x-2">
          <input
            type="text"
            value={inputText}
            onChange={handleInputChange}
            onKeyPress={handleKeyPress}
            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
            disabled={!isConnected}
            className="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
          />
          <button
            onClick={sendMessage}
            disabled={!inputText.trim() || !isConnected}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            <i className="fas fa-paper-plane"></i>
          </button>
        </div>
        
        {/* ì—°ê²° ìƒíƒœ ë©”ì‹œì§€ */}
        {!isConnected && (
          <p className="text-xs text-red-500 mt-2 text-center">
            ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì¤‘...
          </p>
        )}
      </div>
    </div>
  );
}